// navigation-complete-fix.js - ÂÆåÊï¥ÁöÑÂØºËà™‰øÆÂ§çÊñπÊ°à

// ÊõøÊç¢ÂéüÊúâÁöÑ navigation.js Êñá‰ª∂
async function loadNavigation() {
    try {
        // Â∞ùËØï‰ªéCMSÂä†ËΩΩÂØºËà™Êï∞ÊçÆ
        const response = await fetch('/navigation-data.json');
        
        if (!response.ok) {
            throw new Error('Failed to fetch navigation data');
        }
        
        const navData = await response.json();
        console.log('‰ªéCMSÂä†ËΩΩÂØºËà™Êï∞ÊçÆ:', navData);
        
        // ÁîüÊàêÂπ∂ÊèíÂÖ•ÂØºËà™HTML
        document.body.insertAdjacentHTML('afterbegin', generateNavigationHTML(navData));
        
    } catch (error) {
        console.error('CMSÂØºËà™Âä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂØºËà™:', error);
        loadDefaultNavigation();
    }
    
    // ÊÄªÊòØÊèíÂÖ•È°µËÑöÂíåËÆæÁΩÆ‰∫ã‰ª∂
    insertFooter();
    setupNavigationEvents();
    
    // ÂàùÂßãÂåñÊô∫ËÉΩÂØºËà™
    initializeSmartNavigation();
}

// ‰ªéCMSÊï∞ÊçÆÁîüÊàêHTML
function generateNavigationHTML(navData) {
    let desktopNavItems = '';
    let mobileNavItems = '';
    
    (navData.nav_items || []).forEach((item, index) => {
        if (!item.visible) return;
        
        const itemId = `nav-item-${index}`;
        
        if (item.direct_link) {
            desktopNavItems += `
                <div class="nav-item">
                    <a href="${item.direct_link}" onclick="return smartNavigate('${item.direct_link}', event)">${item.label}</a>
                </div>
            `;
            
            mobileNavItems += `
                <div class="mobile-nav-item">
                    <a href="${item.direct_link}" onclick="return smartNavigate('${item.direct_link}', event)">${item.label}</a>
                </div>
            `;
        } else if (item.dropdown_items && item.dropdown_items.length > 0) {
            let dropdownLinks = '';
            let mobileDropdownLinks = '';
            
            item.dropdown_items.forEach((dropItem, dropIndex) => {
                if (!dropItem.visible) return;
                
                dropdownLinks += `
                    <a href="${dropItem.link}" class="dropdown-link" 
                       onclick="return smartNavigate('${dropItem.link}', event)">
                        ${dropItem.label}
                    </a>
                `;
                
                mobileDropdownLinks += `
                    <a href="${dropItem.link}" class="mobile-dropdown-link"
                       onclick="return smartNavigate('${dropItem.link}', event)">
                        ${dropItem.label}
                    </a>
                `;
            });
            
            if (dropdownLinks) {
                desktopNavItems += `
                    <div class="nav-item" data-item-id="${itemId}">
                        <a href="#" class="dropdown-toggle">${item.label}</a>
                        <div class="dropdown">
                            <div class="dropdown-container">
                                ${dropdownLinks}
                            </div>
                        </div>
                    </div>
                `;
                
                mobileNavItems += `
                    <div class="mobile-nav-item" data-item-id="${itemId}">
                        <a href="#" class="mobile-dropdown-toggle" onclick="toggleMobileDropdown(event, this)">
                            ${item.label}
                            <span class="mobile-arrow">·µ•</span>
                        </a>
                        <div class="mobile-dropdown">
                            ${mobileDropdownLinks}
                        </div>
                    </div>
                `;
            }
        }
    });
    
    return `
        <div class="top-banner">
            <div class="title-container">
                <h1 onclick="smartGoHome()" style="cursor: pointer;">${navData.site_title || 'initial research'}</h1>
            </div>
            <nav class="nav-top">
                ${desktopNavItems}
            </nav>
            
            <div class="hamburger-menu" onclick="toggleMobileNav()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            
            <div class="mobile-nav" id="mobileNav">
                ${mobileNavItems}
            </div>
        </div>
    `;
}

// Âä†ËΩΩÈªòËÆ§ÂØºËà™ÔºàÊ†πÊçÆÂÆûÈôÖÊñá‰ª∂ÁªìÊûÑ‰øÆÂ§çÔºâ
function loadDefaultNavigation() {
    const defaultNav = `
        <div class="top-banner">
            <div class="title-container">
                <h1 onclick="smartGoHome()" style="cursor: pointer;">initial research</h1>
            </div>
            <nav class="nav-top">
                <div class="nav-item">
                    <a href="#" class="dropdown-toggle">program</a>
                    <div class="dropdown">
                        <div class="dropdown-container">
                            <a href="program/calendar.html" onclick="return smartNavigate('program/calendar.html', event)">calendar</a>
                            <a href="program/fellowship.html" onclick="return smartNavigate('program/fellowship.html', event)">fellowship</a>
                            <a href="program/communityhours.html" onclick="return smartNavigate('program/communityhours.html', event)">community hours</a>
                            <a href="program/seasonaldinner.html" onclick="return smartNavigate('program/seasonaldinner.html', event)">seasonal dinner</a>
                            <a href="program/exhibition.html" onclick="return smartNavigate('program/exhibition.html', event)">exhibitions</a>
                        </div>
                    </div>
                </div>
                
                <div class="nav-item">
                    <a href="#" class="dropdown-toggle">about</a>
                    <div class="dropdown">
                        <div class="dropdown-container">
                            <a href="about/mission.html" onclick="return smartNavigate('about/mission.html', event)">mission</a>
                            <a href="about/vision.html" onclick="return smartNavigate('about/vision.html', event)">vision</a>
                            <a href="about/team.html" onclick="return smartNavigate('about/team.html', event)">team</a>
                            <a href="about/contact.html" onclick="return smartNavigate('about/contact.html', event)">contact</a>
                        </div>
                    </div>
                </div>
                
                <div class="nav-item">
                    <a href="supportus/supportus.html" onclick="return smartNavigate('supportus/supportus.html', event)">support us</a>
                </div>
            </nav>
            
            <div class="hamburger-menu" onclick="toggleMobileNav()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            
            <div class="mobile-nav" id="mobileNav">
                <div class="mobile-nav-item">
                    <a href="#" class="mobile-dropdown-toggle" onclick="toggleMobileDropdown(event, this)">
                        program
                        <span class="mobile-arrow">·µ•</span>
                    </a>
                    <div class="mobile-dropdown">
                        <a href="program/calendar.html" onclick="return smartNavigate('program/calendar.html', event)">calendar</a>
                        <a href="program/fellowship.html" onclick="return smartNavigate('program/fellowship.html', event)">fellowship</a>
                        <a href="program/communityhours.html" onclick="return smartNavigate('program/communityhours.html', event)">community hours</a>
                        <a href="program/seasonaldinner.html" onclick="return smartNavigate('program/seasonaldinner.html', event)">seasonal dinner</a>
                        <a href="program/exhibition.html" onclick="return smartNavigate('program/exhibition.html', event)">exhibitions</a>
                    </div>
                </div>
                
                <div class="mobile-nav-item">
                    <a href="#" class="mobile-dropdown-toggle" onclick="toggleMobileDropdown(event, this)">
                        about
                        <span class="mobile-arrow">·µ•</span>
                    </a>
                    <div class="mobile-dropdown">
                        <a href="about/mission.html" onclick="return smartNavigate('about/mission.html', event)">mission</a>
                        <a href="about/vision.html" onclick="return smartNavigate('about/vision.html', event)">vision</a>
                        <a href="about/team.html" onclick="return smartNavigate('about/team.html', event)">team</a>
                        <a href="about/contact.html" onclick="return smartNavigate('about/contact.html', event)">contact</a>
                    </div>
                </div>
                
                <div class="mobile-nav-item">
                    <a href="supportus/supportus.html" onclick="return smartNavigate('supportus/supportus.html', event)">support us</a>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('afterbegin', defaultNav);
}

// Êô∫ËÉΩÂØºËà™Á≥ªÁªü
let pathCache = new Map();
let isNavigating = false;

async function smartNavigate(targetPath, event) {
    if (event) {
        event.preventDefault();
    }
    
    if (!targetPath || targetPath === '#' || isNavigating) {
        return false;
    }
    
    isNavigating = true;
    console.log(`üß≠ Êô∫ËÉΩÂØºËà™Âà∞: ${targetPath}`);
    
    try {
        // Ê£ÄÊü•ÁºìÂ≠ò
        if (pathCache.has(targetPath)) {
            const cachedPath = pathCache.get(targetPath);
            console.log(`üìã ‰ΩøÁî®ÁºìÂ≠ò: ${cachedPath}`);
            window.location.href = cachedPath;
            return false;
        }
        
        // Â∞ùËØïÊâæÂà∞Ê≠£Á°ÆË∑ØÂæÑ
        const workingPath = await findWorkingPath(targetPath);
        
        if (workingPath) {
            pathCache.set(targetPath, workingPath);
            console.log(`‚úÖ ÊâæÂà∞Ë∑ØÂæÑ: ${workingPath}`);
            window.location.href = workingPath;
        } else {
            showNavigationError(targetPath);
        }
        
    } catch (error) {
        console.error('ÂØºËà™ÈîôËØØ:', error);
        showNavigationError(targetPath);
    } finally {
        isNavigating = false;
    }
    
    return false;
}

// Êü•ÊâæÂèØÁî®Ë∑ØÂæÑ
async function findWorkingPath(targetPath) {
    const currentPath = window.location.pathname;
    const pathSegments = currentPath.split('/').filter(s => s);
    
    let possiblePaths = [];
    
    // Ê†πÊçÆÂΩìÂâçË∑ØÂæÑÊ∑±Â∫¶ÁîüÊàêÂèØËÉΩÁöÑË∑ØÂæÑ
    if (pathSegments.length <= 1) {
        // Âú®Ê†πÁõÆÂΩïÊàñ‰∏ÄÁ∫ßÁõÆÂΩï
        possiblePaths = [
            targetPath,
            `./${targetPath}`,
            `pages/${targetPath}`,
            `src/${targetPath}`
        ];
    } else if (pathSegments.length === 2) {
        // Âú®‰∫åÁ∫ßÁõÆÂΩï
        possiblePaths = [
            targetPath,
            `../${targetPath}`,
            `./${targetPath}`,
            `../../${targetPath}`
        ];
    } else {
        // Âú®Êõ¥Ê∑±ÁöÑÁõÆÂΩï
        possiblePaths = [
            targetPath,
            `../${targetPath}`,
            `../../${targetPath}`,
            `../../../${targetPath}`,
            `./${targetPath}`
        ];
    }
    
    // Ê∑ªÂä†ÁªùÂØπË∑ØÂæÑÂ∞ùËØï
    possiblePaths.push(`/${targetPath}`);
    
    // Â¶ÇÊûúË∑ØÂæÑÂåÖÂê´Â≠êÁõÆÂΩïÔºåÂ∞ùËØï‰∏çÂêåÁöÑÁªÑÂêà
    if (targetPath.includes('/')) {
        const parts = targetPath.split('/');
        possiblePaths.push(parts[parts.length - 1]); // Âè™ÂèñÊñá‰ª∂Âêç
        
        // Â∞ùËØï‰∏çÂêåÁöÑÂü∫Á°ÄË∑ØÂæÑ
        for (let i = 0; i < pathSegments.length; i++) {
            const basePath = '../'.repeat(i);
            possiblePaths.push(`${basePath}${targetPath}`);
        }
    }
    
    // ÊµãËØïÊØè‰∏™ÂèØËÉΩÁöÑË∑ØÂæÑ
    for (const path of possiblePaths) {
        try {
            console.log(`üîç ÊµãËØïË∑ØÂæÑ: ${path}`);
            const response = await fetch(path, { 
                method: 'HEAD',
                cache: 'no-cache'
            });
            
            if (response.ok) {
                console.log(`‚úÖ Ë∑ØÂæÑÊúâÊïà: ${path}`);
                return path;
            }
        } catch (error) {
            // ÁªßÁª≠ÊµãËØï‰∏ã‰∏Ä‰∏™Ë∑ØÂæÑ
            console.log(`‚ùå Ë∑ØÂæÑÊó†Êïà: ${path}`);
        }
    }
    
    return null;
}

// Êô∫ËÉΩÈ¶ñÈ°µÂØºËà™
async function smartGoHome() {
    const currentPath = window.location.pathname;
    const pathSegments = currentPath.split('/').filter(s => s);
    
    let homePaths = [];
    
    // Ê†πÊçÆÂΩìÂâç‰ΩçÁΩÆÁîüÊàêÈ¶ñÈ°µË∑ØÂæÑ
    if (pathSegments.length <= 1) {
        homePaths = ['index.html', '/', './index.html'];
    } else {
        homePaths = [
            '../'.repeat(pathSegments.length - 1) + 'index.html',
            '../'.repeat(pathSegments.length) + 'index.html',
            '/',
            '/index.html'
        ];
    }
    
    for (const path of homePaths) {
        try {
            const response = await fetch(path, { method: 'HEAD' });
            if (response.ok) {
                window.location.href = path;
                return;
            }
        } catch (error) {
            // ÁªßÁª≠Â∞ùËØï‰∏ã‰∏Ä‰∏™Ë∑ØÂæÑ
        }
    }
    
    // Â¶ÇÊûúÈÉΩÊâæ‰∏çÂà∞ÔºåÂéªÊ†πË∑ØÂæÑ
    window.location.href = '/';
}

// ÊòæÁ§∫ÂØºËà™ÈîôËØØ
function showNavigationError(targetPath) {
    // ÁßªÈô§Áé∞ÊúâÁöÑÈîôËØØÊ∂àÊÅØ
    const existingError = document.querySelector('.nav-error-modal');
    if (existingError) {
        existingError.remove();
    }
    
    const modal = document.createElement('div');
    modal.className = 'nav-error-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            text-align: center;
            font-family: 'Space Grotesk', Arial, sans-serif;
            box-shadow: 0 12px 48px rgba(0,0,0,0.25);
            transform: scale(0.9);
            animation: modalPop 0.3s ease forwards;
        ">
            <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
            <h2 style="color: #ff6b6b; margin: 0 0 16px 0; font-size: 24px;">È°µÈù¢Êú™ÊâæÂà∞</h2>
            <p style="margin: 0 0 12px 0; color: #666; font-size: 16px;">
                Êó†Ê≥ïËÆøÈóÆ: <strong style="color: #333;">${targetPath}</strong>
            </p>
            <p style="margin: 0 0 24px 0; color: #888; font-size: 14px;">
                È°µÈù¢ÂèØËÉΩ‰∏çÂ≠òÂú®ÊàñË∑ØÂæÑ‰∏çÊ≠£Á°Æ
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button onclick="diagnoseNavigation()" style="
                    background: linear-gradient(135deg, #4CAF50, #45a049);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    üîß ËØäÊñ≠ÈóÆÈ¢ò
                </button>
                <button onclick="smartGoHome(); this.closest('.nav-error-modal').remove();" style="
                    background: linear-gradient(135deg, #2196F3, #1976D2);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    üè† ËøîÂõûÈ¶ñÈ°µ
                </button>
                <button onclick="this.closest('.nav-error-modal').remove()" style="
                    background: linear-gradient(135deg, #9E9E9E, #757575);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 500;
                    transition: transform 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                    ‚úï ÂÖ≥Èó≠
                </button>
            </div>
        </div>
        
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes modalPop {
                from { transform: scale(0.9); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
        </style>
    `;
    
    document.body.appendChild(modal);
    
    // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
    
    // 3ÁßíÂêéËá™Âä®ÊòæÁ§∫Âª∫ËÆÆ
    setTimeout(() => {
        if (modal.parentElement) {
            const suggestion = modal.querySelector('div').querySelector('p:last-of-type');
            if (suggestion) {
                suggestion.innerHTML = 'üí° ÊèêÁ§∫ÔºöÊ£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®ÔºåÊàñÁÇπÂáª"ËØäÊñ≠ÈóÆÈ¢ò"Ëé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ';
                suggestion.style.color = '#4CAF50';
            }
        }
    }, 3000);
}

// ËØäÊñ≠ÂØºËà™ÈóÆÈ¢ò
async function diagnoseNavigation() {
    const modal = document.createElement('div');
    modal.className = 'diagnosis-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow-y: auto;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 700px;
            width: 90%;
            margin: 20px;
            font-family: 'Space Grotesk', Arial, sans-serif;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        ">
            <div style="display: flex; align-items: center; margin-bottom: 24px;">
                <div style="font-size: 32px; margin-right: 12px;">üîß</div>
                <h2 style="color: #2196F3; margin: 0;">ÂØºËà™ËØäÊñ≠Â∑•ÂÖ∑</h2>
            </div>
            
            <div id="diagnosis-content" style="margin-bottom: 24px;">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 24px; animation: spin 1s linear infinite;">‚öôÔ∏è</div>
                    <p style="margin-top: 16px; color: #666;">Ê≠£Âú®ËØäÊñ≠ÂØºËà™ÈóÆÈ¢ò...</p>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button onclick="this.closest('.diagnosis-modal').remove()" style="
                    background: linear-gradient(135deg, #2196F3, #1976D2);
                    color: white;
                    border: none;
                    padding: 12px 32px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 500;
                ">ÂÖ≥Èó≠</button>
            </div>
        </div>
        
        <style>
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        </style>
    `;
    
    document.body.appendChild(modal);
    
    // ÂºÄÂßãËØäÊñ≠
    setTimeout(async () => {
        const result = await runDiagnosis();
        displayDiagnosisResult(result);
    }, 1000);
}

// ËøêË°åËØäÊñ≠
async function runDiagnosis() {
    const currentPath = window.location.pathname;
    const currentUrl = window.location.href;
    const pathSegments = currentPath.split('/').filter(s => s);
    
    // Ê†πÊçÆÂÆûÈôÖÊñá‰ª∂ÁªìÊûÑÊµãËØïÈ°µÈù¢
    const testPages = [
        'index.html',
        'program/calendar.html',
        'program/fellowship.html',
        'program/communityhours.html',
        'program/seasonaldinner.html',
        'program/exhibition.html',
        'supportus/supportus.html',
        'about/mission.html',
        'about/vision.html',
        'about/team.html',
        'about/contact.html'
    ];
    
    const foundPages = [];
    const missingPages = [];
    
    for (const page of testPages) {
        const workingPath = await findWorkingPath(page);
        if (workingPath) {
            foundPages.push({ original: page, working: workingPath });
        } else {
            missingPages.push(page);
        }
    }
    
    return {
        currentPath,
        currentUrl,
        pathSegments: pathSegments.length,
        foundPages,
        missingPages,
        suggestions: generateSuggestions(foundPages, missingPages, pathSegments)
    };
}

// ÁîüÊàêÂª∫ËÆÆ
function generateSuggestions(foundPages, missingPages, pathDepth) {
    const suggestions = [];
    
    if (foundPages.length === 0) {
        suggestions.push({
            type: 'error',
            icon: 'üö®',
            title: '‰∏•ÈáçÈóÆÈ¢ò',
            message: 'Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïÈ°µÈù¢Êñá‰ª∂ÔºåËØ∑Ê£ÄÊü•È°πÁõÆÁªìÊûÑÊòØÂê¶Ê≠£Á°Æ'
        });
    } else if (missingPages.length > foundPages.length) {
        suggestions.push({
            type: 'warning',
            icon: '‚ö†Ô∏è',
            title: 'Êñá‰ª∂Áº∫Â§±',
            message: `Êúâ ${missingPages.length} ‰∏™È°µÈù¢Êñá‰ª∂Áº∫Â§±ÔºåËØ∑Ê£ÄÊü•Ëøô‰∫õÊñá‰ª∂ÊòØÂê¶Â≠òÂú®`
        });
    } else {
        suggestions.push({
            type: 'success',
            icon: '‚úÖ',
            title: 'Âü∫Êú¨Ê≠£Â∏∏',
            message: `ÊâæÂà∞‰∫Ü ${foundPages.length} ‰∏™È°µÈù¢ÔºåÂØºËà™Â∫îËØ•ÂèØ‰ª•Ê≠£Â∏∏Â∑•‰Ωú`
        });
    }
    
    if (pathDepth > 2) {
        suggestions.push({
            type: 'info',
            icon: 'üìÅ',
            title: 'Ë∑ØÂæÑÊ∑±Â∫¶',
            message: 'ÂΩìÂâçÂú®Ê∑±Â±ÇÁõÆÂΩï‰∏≠ÔºåÂèØËÉΩÈúÄË¶ÅË∞ÉÊï¥Áõ∏ÂØπË∑ØÂæÑ'
        });
    }
    
    suggestions.push({
        type: 'tip',
        icon: 'üí°',
        title: 'Ë∞ÉËØïÊèêÁ§∫',
        message: 'Âú®URLÂêéÊ∑ªÂä† ?debug=true ÂèØ‰ª•ÂºÄÂêØË∞ÉËØïÊ®°Âºè'
    });
    
    return suggestions;
}

// ÊòæÁ§∫ËØäÊñ≠ÁªìÊûú
function displayDiagnosisResult(result) {
    const content = document.getElementById('diagnosis-content');
    if (!content) return;
    
    content.innerHTML = `
        <div style="margin-bottom: 24px;">
            <h3 style="color: #333; margin-bottom: 12px;">üìä ËØäÊñ≠ÁªìÊûú</h3>
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <p style="margin: 4px 0;"><strong>ÂΩìÂâçË∑ØÂæÑ:</strong> ${result.currentPath}</p>
                <p style="margin: 4px 0;"><strong>ÁõÆÂΩïÊ∑±Â∫¶:</strong> ${result.pathSegments} Â±Ç</p>
                <p style="margin: 4px 0;"><strong>ÊâæÂà∞È°µÈù¢:</strong> ${result.foundPages.length} ‰∏™</p>
                <p style="margin: 4px 0;"><strong>Áº∫Â§±È°µÈù¢:</strong> ${result.missingPages.length} ‰∏™</p>
            </div>
        </div>
        
        ${result.foundPages.length > 0 ? `
        <div style="margin-bottom: 24px;">
            <h4 style="color: #4CAF50; margin-bottom: 12px;">‚úÖ ÊâæÂà∞ÁöÑÈ°µÈù¢</h4>
            <div style="max-height: 200px; overflow-y: auto;">
                ${result.foundPages.map(p => `
                    <div style="padding: 8px; background: #f0f8f0; margin: 4px 0; border-radius: 4px; font-size: 14px;">
                        <strong>${p.original}</strong> ‚Üí <code>${p.working}</code>
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        ${result.missingPages.length > 0 ? `
        <div style="margin-bottom: 24px;">
            <h4 style="color: #ff6b6b; margin-bottom: 12px;">‚ùå Áº∫Â§±ÁöÑÈ°µÈù¢</h4>
            <div style="max-height: 150px; overflow-y: auto;">
                ${result.missingPages.map(p => `
                    <div style="padding: 8px; background: #fff0f0; margin: 4px 0; border-radius: 4px; font-size: 14px;">
                        ${p}
                    </div>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        <div style="margin-bottom: 24px;">
            <h4 style="color: #2196F3; margin-bottom: 12px;">üí° Âª∫ËÆÆÂíåÊèêÁ§∫</h4>
            ${result.suggestions.map(s => `
                <div style="padding: 12px; margin: 8px 0; border-radius: 8px; border-left: 4px solid ${getSuggestionColor(s.type)}; background: ${getSuggestionBg(s.type)};">
                    <div style="font-weight: 500; margin-bottom: 4px;">
                        ${s.icon} ${s.title}
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ${s.message}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Ëé∑ÂèñÂª∫ËÆÆÈ¢úËâ≤
function getSuggestionColor(type) {
    const colors = {
        error: '#f44336',
        warning: '#ff9800',
        success: '#4caf50',
        info: '#2196f3',
        tip: '#9c27b0'
    };
    return colors[type] || '#666';
}

function getSuggestionBg(type) {
    const backgrounds = {
        error: '#ffebee',
        warning: '#fff3e0',
        success: '#e8f5e8',
        info: '#e3f2fd',
        tip: '#f3e5f5'
    };
    return backgrounds[type] || '#f5f5f5';
}

// ËÆæÁΩÆÂØºËà™‰∫ã‰ª∂
function setupNavigationEvents() {
    const navItems = document.querySelectorAll('.nav-item');
    
    navItems.forEach(item => {
        const dropdown = item.querySelector('.dropdown');
        if (dropdown) {
            // Ê°åÈù¢Á´ØÊÇ¨ÂÅú
            if (window.innerWidth > 768) {
                item.addEventListener('mouseenter', () => {
                    document.querySelectorAll('.nav-item').forEach(i => {
                        if (i !== item) i.classList.remove('active');
                    });
                    item.classList.add('active');
                });
                
                item.addEventListener('mouseleave', () => {
                    item.classList.remove('active');
                });
            }
            
            // ÁÇπÂáªÂàáÊç¢
            const toggle = item.querySelector('.dropdown-toggle');
            if (toggle) {
                toggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-item').forEach(i => {
                        if (i !== item) i.classList.remove('active');
                    });
                    item.classList.toggle('active');
                    e.stopPropagation();
                });
            }
        }
    });
    
    // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.nav-item') && 
            !e.target.closest('.mobile-nav') && 
            !e.target.closest('.hamburger-menu')) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
        }
    });
}

// ÁßªÂä®Á´ØÂØºËà™
window.toggleMobileNav = function() {
    const mobileNav = document.getElementById('mobileNav');
    if (mobileNav.style.display === 'flex' || mobileNav.classList.contains('show')) {
        mobileNav.style.display = 'none';
        mobileNav.classList.remove('show');
        document.querySelectorAll('.mobile-nav-item').forEach(item => {
            item.classList.remove('active');
        });
    } else {
        mobileNav.style.display = 'flex';
        mobileNav.classList.add('show');
    }
};

window.toggleMobileDropdown = function(e, element) {
    e.preventDefault();
    const navItem = element.parentElement;
    const dropdown = navItem.querySelector('.mobile-dropdown');
    
    if (!dropdown) return;
    
    document.querySelectorAll('.mobile-nav-item').forEach(item => {
        if (item !== navItem) item.classList.remove('active');
    });
    
    navItem.classList.toggle('active');
};

// ÊèíÂÖ•È°µËÑö
function insertFooter() {
    const footer = `
        <footer style="
            margin-top: auto;
            width: 100%;
            background-color: rgb(180, 180, 180);
            padding: 10px 0;
            text-align: center;
            font-family: 'Space Grotesk', Helvetica, Arial, sans-serif;
            font-size: 16px;
            font-weight: 300;
            color: rgb(23, 23, 23);
            z-index: 1;
        ">
            124 Gallery Street, New York, NY 10001
        </footer>
    `;
    document.body.insertAdjacentHTML('beforeend', footer);
}

// ÂàùÂßãÂåñÊô∫ËÉΩÂØºËà™
function initializeSmartNavigation() {
    // ÂÖ®Â±ÄÂáΩÊï∞
    window.smartNavigate = smartNavigate;
    window.smartGoHome = smartGoHome;
    window.diagnoseNavigation = diagnoseNavigation;
    
    // ÈîÆÁõòÂø´Êç∑ÈîÆ
    document.addEventListener('keydown', (e) => {
        // Ctrl+Shift+D ËØäÊñ≠
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
            e.preventDefault();
            diagnoseNavigation();
        }
        
        // Ctrl+Shift+H ÂõûÈ¶ñÈ°µ
        if (e.ctrlKey && e.shiftKey && e.key === 'H') {
            e.preventDefault();
            smartGoHome();
        }
    });
    
    // Ëá™Âä®ËØäÊñ≠ÔºàË∞ÉËØïÊ®°ÂºèÔºâ
    if (window.location.search.includes('debug=true')) {
        setTimeout(diagnoseNavigation, 1000);
    }
    
    console.log('üöÄ Êô∫ËÉΩÂØºËà™Á≥ªÁªüÂ∑≤ÂêØÂä®');
    console.log('üí° Âø´Êç∑ÈîÆ: Ctrl+Shift+D (ËØäÊñ≠), Ctrl+Shift+H (È¶ñÈ°µ)');
}

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', loadNavigation);
